name: ğŸ›¡ï¸ Athena - UI/UX Guardian

on:
  pull_request:
    types: [opened, synchronize, reopened]

jobs:
  athena-analysis:
    runs-on: ubuntu-latest
    name: Analyze UI/UX Impact
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
      
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'
      
      - name: Install dependencies
        run: npm ci
      
      - name: Build project
        run: npm run build
      
      - name: Analyze Bundle Size
        id: bundle
        run: |
          CURRENT_SIZE=$(du -sb dist | cut -f1)
          git checkout ${{ github.event.pull_request.base.sha }}
          npm ci
          npm run build
          BASE_SIZE=$(du -sb dist | cut -f1)
          DELTA=$((CURRENT_SIZE - BASE_SIZE))
          DELTA_KB=$((DELTA / 1024))
          echo "delta_kb=$DELTA_KB" >> $GITHUB_OUTPUT
          echo "current_mb=$((CURRENT_SIZE / 1024 / 1024))" >> $GITHUB_OUTPUT
          echo "base_mb=$((BASE_SIZE / 1024 / 1024))" >> $GITHUB_OUTPUT
      
      - name: Run Lighthouse CI
        id: lighthouse
        uses: treosh/lighthouse-ci-action@v10
        with:
          urls: |
            http://localhost:8080
          uploadArtifacts: true
          temporaryPublicStorage: true
        continue-on-error: true
      
      - name: Check Accessibility
        id: a11y
        run: |
          npx @axe-core/cli dist/**/*.html --exit
        continue-on-error: true
      
      - name: Check Design System Compliance
        id: design-system
        run: |
          VIOLATIONS=$(grep -r "color:\s*#" src/ --include="*.tsx" --include="*.ts" | wc -l || echo "0")
          echo "violations=$VIOLATIONS" >> $GITHUB_OUTPUT
      
      - name: Post Athena Report
        uses: actions/github-script@v7
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          script: |
            const bundleDelta = ${{ steps.bundle.outputs.delta_kb }};
            const currentMB = ${{ steps.bundle.outputs.current_mb }};
            const baseMB = ${{ steps.bundle.outputs.base_mb }};
            const designViolations = ${{ steps.design-system.outputs.violations }};
            
            let warnings = [];
            let criticals = [];
            
            if (bundleDelta > 50) {
              criticals.push(`ğŸ“¦ **Bundle Size**: Increased by ${bundleDelta}KB (${baseMB}MB â†’ ${currentMB}MB). Target: <50KB increase.`);
            } else if (bundleDelta > 25) {
              warnings.push(`ğŸ“¦ **Bundle Size**: Increased by ${bundleDelta}KB. Consider code splitting.`);
            }
            
            if (designViolations > 0) {
              warnings.push(`ğŸ¨ **Design System**: Found ${designViolations} direct color usage(s). Use CSS variables instead.`);
            }
            
            const emoji = criticals.length > 0 ? 'âš ï¸' : warnings.length > 0 ? 'âš¡' : 'âœ…';
            const status = criticals.length > 0 ? 'WARNINGS DETECTED' : warnings.length > 0 ? 'Minor Issues Found' : 'ALL CHECKS PASSED';
            
            let comment = `## ${emoji} Athena UI/UX Analysis - ${status}\n\n`;
            
            if (criticals.length > 0) {
              comment += `### ğŸš¨ Critical Warnings\n${criticals.map(w => `- ${w}`).join('\n')}\n\n`;
            }
            
            if (warnings.length > 0) {
              comment += `### âš¡ Warnings\n${warnings.map(w => `- ${w}`).join('\n')}\n\n`;
            }
            
            if (criticals.length === 0 && warnings.length === 0) {
              comment += `### âœ¨ Perfect!\nNo UI/UX regressions detected. Bundle size: ${currentMB}MB.\n\n`;
            }
            
            comment += `---\n*ğŸ›¡ï¸ Athena Guardian | Merge allowed with warnings*`;
            
            github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: comment
            });

  test-coverage:
    runs-on: ubuntu-latest
    name: Test Coverage Analysis
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'
          
      - name: Install dependencies
        run: npm ci
        
      - name: Run tests with coverage
        run: npm run test:coverage
        continue-on-error: true
        
      - name: Check transaction alert coverage thresholds
        id: coverage-check
        run: |
          # Check if coverage report exists
          if [ ! -f coverage/coverage-summary.json ]; then
            echo "Coverage report not found, skipping threshold check"
            echo "coverage_passed=true" >> $GITHUB_OUTPUT
            exit 0
          fi
          
          # Extract coverage for critical transaction alert files
          HOOKS_COV=$(cat coverage/coverage-summary.json | jq -r '.["src/hooks/useTransactionAlerts.ts"].lines.pct // 0' 2>/dev/null || echo "0")
          TOAST_COV=$(cat coverage/coverage-summary.json | jq -r '.["src/components/alerts/TransactionAlertToast.tsx"].lines.pct // 0' 2>/dev/null || echo "0")
          BANNER_COV=$(cat coverage/coverage-summary.json | jq -r '.["src/components/alerts/TransactionAlertBanner.tsx"].lines.pct // 0' 2>/dev/null || echo "0")
          TOTAL_COV=$(cat coverage/coverage-summary.json | jq -r '.total.lines.pct // 0' 2>/dev/null || echo "0")
          
          echo "hooks_cov=$HOOKS_COV" >> $GITHUB_OUTPUT
          echo "toast_cov=$TOAST_COV" >> $GITHUB_OUTPUT
          echo "banner_cov=$BANNER_COV" >> $GITHUB_OUTPUT
          echo "total_cov=$TOTAL_COV" >> $GITHUB_OUTPUT
          
          # Check thresholds (80% minimum for transaction alert system)
          PASSED=true
          if [ "$(echo "$HOOKS_COV < 80" | bc -l 2>/dev/null || echo "0")" = "1" ] && [ "$HOOKS_COV" != "0" ]; then
            echo "âŒ useTransactionAlerts coverage ($HOOKS_COV%) below 80% threshold"
            PASSED=false
          fi
          
          echo "coverage_passed=$PASSED" >> $GITHUB_OUTPUT
        continue-on-error: true
          
      - name: Upload coverage to Codecov
        uses: codecov/codecov-action@v4
        with:
          files: ./coverage/lcov.info
          fail_ci_if_error: false
          token: ${{ secrets.CODECOV_TOKEN }}
        continue-on-error: true
          
      - name: Post Coverage Report
        uses: actions/github-script@v7
        if: github.event_name == 'pull_request'
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          script: |
            const hooksCov = '${{ steps.coverage-check.outputs.hooks_cov }}' || 'N/A';
            const toastCov = '${{ steps.coverage-check.outputs.toast_cov }}' || 'N/A';
            const bannerCov = '${{ steps.coverage-check.outputs.banner_cov }}' || 'N/A';
            const totalCov = '${{ steps.coverage-check.outputs.total_cov }}' || 'N/A';
            const passed = '${{ steps.coverage-check.outputs.coverage_passed }}' === 'true';
            
            const getStatus = (cov) => {
              const num = parseFloat(cov);
              if (isNaN(num) || cov === 'N/A' || cov === '0') return 'âšª';
              if (num >= 90) return 'âœ…';
              if (num >= 80) return 'ğŸŸ¡';
              return 'âŒ';
            };
            
            const emoji = passed ? 'âœ…' : 'âš ï¸';
            const status = passed ? 'THRESHOLDS MET' : 'COVERAGE BELOW THRESHOLD';
            
            let comment = `## ğŸ§ª Test Coverage Report - ${emoji} ${status}\n\n`;
            
            comment += `### ğŸ“Š Transaction Alert System Coverage\n\n`;
            comment += `| File | Coverage | Threshold | Status |\n`;
            comment += `|------|----------|-----------|--------|\n`;
            comment += `| \`useTransactionAlerts.ts\` | ${hooksCov}% | 80% | ${getStatus(hooksCov)} |\n`;
            comment += `| \`TransactionAlertToast.tsx\` | ${toastCov}% | 80% | ${getStatus(toastCov)} |\n`;
            comment += `| \`TransactionAlertBanner.tsx\` | ${bannerCov}% | 80% | ${getStatus(bannerCov)} |\n`;
            comment += `\n`;
            
            comment += `### ğŸ“ˆ Overall Coverage\n\n`;
            comment += `| Metric | Value |\n`;
            comment += `|--------|-------|\n`;
            comment += `| Total Lines | ${totalCov}% |\n`;
            comment += `\n`;
            
            if (!passed) {
              comment += `### âš ï¸ Action Required\n`;
              comment += `Transaction alert system coverage is below the 80% threshold. Please add tests before merging.\n\n`;
            }
            
            comment += `---\n*ğŸ›¡ï¸ Athena Guardian | Test Coverage Analysis*`;
            
            github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: comment
            });
