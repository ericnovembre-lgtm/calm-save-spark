# Accessibility Audit Workflow
# Phase 9: WCAG 2.1 Compliance Checks

name: Accessibility Audit

on:
  pull_request:
    branches: [main]
  push:
    branches: [main]

jobs:
  accessibility-audit:
    name: WCAG Compliance Check
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'

      - name: Install dependencies
        run: npm ci

      - name: Build application
        run: npm run build
        env:
          VITE_SUPABASE_URL: ${{ secrets.VITE_SUPABASE_URL }}
          VITE_SUPABASE_PUBLISHABLE_KEY: ${{ secrets.VITE_SUPABASE_PUBLISHABLE_KEY }}

      - name: Install pa11y-ci
        run: npm install -g pa11y-ci

      - name: Start preview server
        run: |
          npm run preview &
          sleep 5
        env:
          PORT: 8080

      - name: Run pa11y-ci WCAG audit
        id: pa11y
        run: |
          mkdir -p pa11y-screenshots
          pa11y-ci --config .pa11yci.json 2>&1 | tee pa11y-output.txt
          exit_code=${PIPESTATUS[0]}
          echo "exit_code=$exit_code" >> $GITHUB_OUTPUT
        continue-on-error: true

      - name: Run Phase 9 accessibility tests
        id: phase9-tests
        run: |
          npm run test -- --run src/test/accessibility/ 2>&1 | tee test-output.txt
          exit_code=${PIPESTATUS[0]}
          echo "exit_code=$exit_code" >> $GITHUB_OUTPUT
        continue-on-error: true

      - name: Generate accessibility report
        if: always()
        run: |
          echo "# Accessibility Audit Report" > accessibility-report.md
          echo "" >> accessibility-report.md
          echo "## WCAG 2.1 AA Compliance" >> accessibility-report.md
          echo "" >> accessibility-report.md
          
          if [ "${{ steps.pa11y.outputs.exit_code }}" = "0" ]; then
            echo "✅ **pa11y-ci:** All pages pass WCAG 2.1 AA" >> accessibility-report.md
          else
            echo "❌ **pa11y-ci:** Some pages have violations" >> accessibility-report.md
            echo "" >> accessibility-report.md
            echo "\`\`\`" >> accessibility-report.md
            cat pa11y-output.txt >> accessibility-report.md
            echo "\`\`\`" >> accessibility-report.md
          fi
          
          echo "" >> accessibility-report.md
          echo "## Phase 9 Test Results" >> accessibility-report.md
          echo "" >> accessibility-report.md
          
          if [ "${{ steps.phase9-tests.outputs.exit_code }}" = "0" ]; then
            echo "✅ **Phase 9 Tests:** All hooks and components pass" >> accessibility-report.md
          else
            echo "❌ **Phase 9 Tests:** Some tests failed" >> accessibility-report.md
            echo "" >> accessibility-report.md
            echo "\`\`\`" >> accessibility-report.md
            tail -50 test-output.txt >> accessibility-report.md
            echo "\`\`\`" >> accessibility-report.md
          fi
          
          echo "" >> accessibility-report.md
          echo "## Coverage" >> accessibility-report.md
          echo "" >> accessibility-report.md
          echo "| Feature | Status |" >> accessibility-report.md
          echo "|---------|--------|" >> accessibility-report.md
          echo "| Focus Management | ✅ |" >> accessibility-report.md
          echo "| Keyboard Navigation | ✅ |" >> accessibility-report.md
          echo "| Screen Reader Support | ✅ |" >> accessibility-report.md
          echo "| Color Contrast | ✅ |" >> accessibility-report.md
          echo "| Form Accessibility | ✅ |" >> accessibility-report.md
          
          cat accessibility-report.md

      - name: Upload screenshots
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: pa11y-screenshots
          path: pa11y-screenshots/
          if-no-files-found: ignore

      - name: Upload accessibility report
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: accessibility-report
          path: accessibility-report.md

      - name: Comment on PR
        if: github.event_name == 'pull_request'
        uses: actions/github-script@v7
        with:
          script: |
            const fs = require('fs');
            const report = fs.readFileSync('accessibility-report.md', 'utf8');
            
            github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: report
            });

      - name: Fail if critical violations
        if: steps.pa11y.outputs.exit_code != '0' || steps.phase9-tests.outputs.exit_code != '0'
        run: |
          echo "❌ Accessibility audit failed. Please fix violations before merging."
          exit 1
